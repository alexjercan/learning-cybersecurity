# Stonks

[Stonks](https://play.picoctf.org/practice/challenge/105)

## Description

I decided to try something noone else has before. I made a bot to automatically trade stonks for me using AI and machine learning. I wouldn't believe you if you told me it's unsecure! vuln.c `nc mercury.picoctf.net 16439`

## Solution

When we compile the vuln.c script we can see the following message

```
vuln.c: In function ‘buy_stonks’:
vuln.c:93:2: warning: format not a string literal and no format arguments [-Wformat-security]
   93 |  printf(user_buf);
      |  ^~~~~~
```

We can investigate this warning message and find that the developer included a format string attack vulnerability by passing a user controlled string into printf.

To be able to run the application we have to create a dummy flag in a file named api.
We can write something like "AAAABBBB..." to be able to find it more easily.

Since the `api_buf` variable is allocated on the stack, and we know that the functions take arguments from the stack, we can try and pass a string like "%p%p%p..." and see if we find the dummy flag. We notice that the 12th %p returns 4242424241414141 which is little endian for our dummy string. We also know that the flag will have 128 bytes, so we have to leak from the 12th position to the 27th position inclusive.

Testing my approach using the server I noticed different offsets, and checking the vuln.c file more I have seen a variable `#define MAX_SYM_LEN 4` which made me think that the server uses a 32 bit version of the application. The actual position that we need to check are in fact from 15 to 25. We can send a payload containing "%{i}$#010x" for i from 15 to 25 and we will receive back the flag in little endian format.

From there we can use `struct` to decode the adresses and convert the text to string.
